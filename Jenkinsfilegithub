pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                echo "Build the code using Maven"
            }
        }

        stage('Unit and Integration Test') {
            steps {
                echo "Run unit tests using Junit"
            }
            post {
                always {
                    script {
                        // Send email notification after Unit and Integration Test stage
                        sendNotification(currentBuild.currentResult, "Unit and Integration Test")
                    }
                }
            }
        }
        stage('Code Analysis') {
            steps {
                echo "Analyze the code using SonarQube"
            }
        }
        stage('Security Scan') {
            steps {
                echo "Perform a security scan using OWASP"
            }
            post {
                always {
                    script {
                        // Send email notification after Security Scan stage
                        sendNotification(currentBuild.currentResult, "Security Scan")
                    }
                }
            }
        }
        stage('Deploy to Staging') {
            steps {
                echo "Deploy to staging using AWS"
            }
        }
        stage('Integration test on staging') {
            steps {
                echo "Run integration tests on staging environment"
            }
        }
        stage('Deploy to production') {
            steps {
                echo "Deploy the application to the production environment"
            }
        }
    }
}

def sendNotification(status, stage) {
    // Sending email to specified email address
    emailext(
        to: 'kaiiyang52@gmail.com',
        subject: "Build ${status}: ${stage}",
        body: "The ${stage} stage has ${status}. Please check the Jenkins logs for more details."
    )
}
